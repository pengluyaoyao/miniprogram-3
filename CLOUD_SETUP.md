# 云开发配置指南

## 环境配置

### 1. 云开发环境ID
- 环境ID: `cloud1-2grdaeu00966fc03`
- 已在 `miniprogram/app.ts` 中配置

### 2. 云函数列表

#### 用户相关云函数
- `userLogin` - 微信登录/注册
- `phoneLogin` - 手机号登录
- `getPhoneNumber` - 获取用户手机号
- `sendSmsCode` - 发送短信验证码
- `updateUserInfo` - 更新用户信息
- `updateUserStats` - 更新用户统计信息

#### 系统云函数
- `initDatabase` - 初始化数据库集合

### 3. 数据库集合

#### 用户集合 (users)
```javascript
{
  _id: "用户ID",
  openid: "微信openid",
  nickname: "用户昵称",
  avatar: "头像URL",
  gender: "性别",
  city: "城市",
  province: "省份",
  country: "国家",
  phone: "手机号",
  stats: {
    posts: "发布数量",
    likes: "点赞数量",
    follows: "关注数量",
    collections: "收藏数量",
    comments: "评论数量",
    analysis: "分析数量"
  },
  createTime: "创建时间",
  updateTime: "更新时间"
}
```

#### 短信验证码集合 (sms_codes)
```javascript
{
  _id: "验证码ID",
  phone: "手机号",
  code: "验证码",
  createTime: "创建时间",
  expireTime: "过期时间"
}
```

### 4. 部署步骤

#### 4.1 在微信开发者工具中部署云函数

1. 打开微信开发者工具
2. 右键点击 `cloudfunctions` 文件夹
3. 选择"创建并部署：云端安装依赖"
4. 等待部署完成

#### 4.2 初始化数据库

1. 在云开发控制台中调用 `initDatabase` 云函数
2. 或者手动创建以下集合：
   - users
   - sms_codes
   - house_analysis
   - posts
   - comments
   - collections

### 5. 权限配置

#### 5.1 云函数权限
- 所有云函数都已配置用户身份验证
- 只有用户本人可以修改自己的信息

#### 5.2 数据库权限
- 建议配置为"仅创建者可读写"
- 或者根据需要配置自定义权限规则

### 6. 功能说明

#### 6.1 微信登录流程
1. 用户点击微信登录按钮
2. 获取用户授权信息
3. 调用 `userLogin` 云函数
4. 云函数检查用户是否存在
5. 新用户自动注册，老用户更新信息
6. 返回用户信息并保存到本地

#### 6.2 手机号登录流程
1. 用户点击获取手机号按钮
2. 调用 `getPhoneNumber` 云函数获取手机号
3. 用户点击发送验证码
4. 调用 `sendSmsCode` 云函数发送验证码
5. 用户输入验证码并点击登录
6. 调用 `phoneLogin` 云函数验证并登录

#### 6.3 头像上传流程
1. 用户选择图片
2. 上传到云存储
3. 调用 `updateUserInfo` 云函数更新头像URL
4. 更新本地用户信息

### 7. 注意事项

1. **短信服务**: 当前短信验证码功能为模拟实现，实际使用时需要集成真实的短信服务商
2. **云存储**: 头像上传使用云存储，需要配置存储权限
3. **安全**: 所有云函数都包含权限验证，确保数据安全
4. **性能**: 建议对频繁查询的数据建立索引

### 8. 测试

1. 在微信开发者工具中测试登录功能
2. 检查云开发控制台中的数据库数据
3. 验证云函数调用日志
4. 测试头像上传功能

### 9. 故障排除

#### 9.1 常见问题
- 云函数调用失败：检查网络连接和云开发环境配置
- 数据库操作失败：检查权限配置和集合是否存在
- 头像上传失败：检查云存储权限配置

#### 9.2 调试方法
- 查看云函数调用日志
- 检查数据库操作日志
- 使用微信开发者工具的调试功能
