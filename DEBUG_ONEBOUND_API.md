# 万邦 OpenAI API 调用诊断指南

## 🔍 问题描述

`test-onebound-openai.js` 工作正常，但云函数 `aiAnalysis/index.js` 似乎没有调用万邦 API。

## 🛠️ 诊断步骤

### 已添加的调试日志

我已经在云函数中添加了详细的日志，用于追踪整个调用链：

#### 1. **processAnalysisInBackground** 函数入口
```
╔════════════════════════════════════════════════════════════════╗
║  ⚙️  processAnalysisInBackground 开始执行                      ║
╚════════════════════════════════════════════════════════════════╝
后台处理任务ID: xxx
传入的 params: { ... }
```

#### 2. **submitBailianTask** 函数入口
```
╔════════════════════════════════════════════════════════════════╗
║  🚀 submitBailianTask 函数被调用                              ║
╚════════════════════════════════════════════════════════════════╝
接收的参数: { ... }
任务ID: xxx
提取的图片URL (houseDescription): https://...
```

#### 3. **validateAndDescribeFloorPlan** 函数入口
```
╔════════════════════════════════════════════════════════════════╗
║  🔍 validateAndDescribeFloorPlan 函数被调用                    ║
╚════════════════════════════════════════════════════════════════╝
图片URL: https://...
图片URL长度: xxx
```

#### 4. **万邦API调用详情**
```
==================== 万邦API调用详情 ====================
API 配置:
  - Base URL: https://api-1.onebound.cn/openai/custom/
  - Key: t3262600923
  - Secret: 0923a669
  - Model: gpt-4
Method: v1/chat/completions
Messages 数量: 1
完整 URL (前 200 字符): https://...
开始发送请求...
===========================================================
```

#### 5. **万邦API响应**
```
✅ HTTP 请求成功！万邦OpenAI API耗时: XX.XX 秒
HTTP 状态码: 200
==================== 万邦API响应详情 ====================
完整响应: { ... }
===========================================================
✅ 万邦API返回成功 (error_code: 0000)
Request ID: xxx
```

## 📋 检查清单

### 步骤1: 部署更新后的云函数

```bash
# 在微信开发者工具中
# 右键 cloudfunctions/aiAnalysis
# 选择 "上传并部署：云端安装依赖"
```

### 步骤2: 测试并查看日志

1. **触发分析**
   - 在小程序中上传户型图
   - 提交分析请求

2. **查看云函数日志**
   - 打开微信开发者工具
   - 云开发 → 云函数 → aiAnalysis → 日志

3. **检查日志输出**

#### ✅ 正常情况应该看到：

```log
╔════════════════════════════════════════════════════════════════╗
║  ⚙️  processAnalysisInBackground 开始执行                      ║
╚════════════════════════════════════════════════════════════════╝
后台处理任务ID: abc123
传入的 params: {
  "imageUrl": "https://636c-cloud1-2grdaeu00966fc03-1380239870.tcb.qcloud.la/...",
  "houseInfo": { ... }
}

即将调用 submitBailianTask...

╔════════════════════════════════════════════════════════════════╗
║  🚀 submitBailianTask 函数被调用                              ║
╚════════════════════════════════════════════════════════════════╝
接收的参数: { ... }
提取的图片URL (houseDescription): https://...

╔════════════════════════════════════════════════════════════════╗
║  🔍 validateAndDescribeFloorPlan 函数被调用                    ║
╚════════════════════════════════════════════════════════════════╝
图片URL: https://...

==================== 万邦API调用详情 ====================
API 配置:
  - Base URL: https://api-1.onebound.cn/openai/custom/
  - Key: t3262600923
  - Secret: 0923a669
  - Model: gpt-4
===========================================================

✅ HTTP 请求成功！万邦OpenAI API耗时: 18.45 秒
HTTP 状态码: 200

==================== 万邦API响应详情 ====================
{
  "error_code": "0000",
  "response": {
    "choices": [
      {
        "message": {
          "content": "合格可用于户型分析\n\n**户型整体结构**：..."
        }
      }
    ]
  }
}
===========================================================

✅ 万邦API返回成功 (error_code: 0000)
户型图验证结果: ✅ 合格
```

#### ❌ 如果没有看到上述日志：

可能的问题：

1. **云函数没有被调用**
   - 检查前端是否正确调用 `wx.cloud.callFunction`
   - 检查云函数名称是否正确

2. **后台任务没有启动**
   - 检查是否看到 `processAnalysisInBackground 开始执行`
   - 如果没有，说明异步任务没有启动

3. **函数没有执行到验证步骤**
   - 检查是否有提前 return 或 throw
   - 查看错误日志

### 步骤3: 对比测试脚本

运行测试脚本确认API可达：

```bash
cd /Users/pengluyao/WeChatProjects/miniprogram-3
node test-onebound-openai.js
```

**预期输出**：
```
✅ API 调用成功！
耗时: 16.23 秒
==================== AI 回复内容 ====================
合格可用于户型分析
**户型整体结构**：...
```

## 🔧 常见问题排查

### 问题1: 日志中没有看到 `validateAndDescribeFloorPlan 函数被调用`

**可能原因**：
- `submitBailianTask` 没有被调用
- 参数传递有问题
- 提前抛出异常

**解决方案**：
1. 查找 `submitBailianTask 函数被调用` 日志
2. 检查是否有错误信息
3. 查看 `传入的 params` 是否包含 `imageUrl`

### 问题2: 看到函数被调用，但没有看到 API 响应

**可能原因**：
- 网络超时
- API 请求失败
- 云函数环境网络限制

**解决方案**：
1. 查看是否有超时错误（120秒）
2. 检查云函数的网络配置
3. 尝试在云端运行测试脚本

### 问题3: API 返回错误

**可能的错误码**：

| Error Code | 说明 | 解决方案 |
|------------|------|----------|
| `2000` | API Key 无效或余额不足 | 检查 API Key 和账户余额 |
| `4003` | 参数错误 | 检查请求参数格式 |
| `timeout` | 请求超时 | 增加超时时间或优化请求 |

### 问题4: 测试脚本成功，但云函数失败

**可能原因**：
- 云函数网络环境与本地不同
- 云函数依赖没有正确安装
- 环境变量配置问题

**解决方案**：

1. **检查依赖**
   ```bash
   cd cloudfunctions/aiAnalysis
   npm install
   ```

2. **重新部署**
   - 右键云函数
   - 选择 "上传并部署：云端安装依赖"

3. **检查 package.json**
   ```json
   {
     "dependencies": {
       "wx-server-sdk": "~2.6.3",
       "axios": "^1.6.0"
     }
   }
   ```

## 📊 日志分析

### 成功的日志序列

```
1. ⚙️  processAnalysisInBackground 开始执行
   ↓
2. 🚀 submitBailianTask 函数被调用
   ↓
3. 🔍 validateAndDescribeFloorPlan 函数被调用
   ↓
4. 万邦API调用详情
   ↓
5. ✅ HTTP 请求成功
   ↓
6. ✅ 万邦API返回成功
   ↓
7. ✅ 户型图验证通过
   ↓
8. 百炼AI 正在进行风水分析
   ↓
9. ✅ 分析完成
```

### 失败的日志模式

#### 模式1: 函数未被调用
```
[没有任何相关日志]
```
→ **问题**：云函数没有启动或前端调用失败

#### 模式2: 提前失败
```
⚙️  processAnalysisInBackground 开始执行
[错误信息]
[没有后续日志]
```
→ **问题**：参数错误或初始化失败

#### 模式3: API 调用失败
```
⚙️  processAnalysisInBackground 开始执行
🚀 submitBailianTask 函数被调用
🔍 validateAndDescribeFloorPlan 函数被调用
万邦API调用详情
[错误: timeout / connection error]
```
→ **问题**：网络问题或 API 服务问题

## 🎯 下一步行动

### 1. 立即操作
- [ ] 部署更新后的云函数
- [ ] 上传户型图触发分析
- [ ] 查看云函数日志
- [ ] 截图日志发送给我

### 2. 收集信息

如果问题仍然存在，请提供：

1. **完整的云函数日志**（从头到尾）
2. **前端调用代码**
3. **错误信息**（如果有）
4. **测试脚本的输出**（node test-onebound-openai.js）

### 3. 对比代码

我已经确认：
- ✅ URL 构建方式相同
- ✅ API 配置相同
- ✅ 请求参数格式相同
- ✅ 响应解析方式相同

唯一的区别是**环境**：
- 测试脚本：本地 Node.js
- 云函数：腾讯云服务器

## 📞 技术支持

如果以上步骤都无法解决问题，请：

1. **导出完整日志**
   - 云开发 → 云函数 → aiAnalysis → 日志
   - 选择时间范围
   - 导出为文本

2. **发送给我**，包括：
   - 云函数日志
   - 测试脚本输出
   - 前端调用代码
   - 错误截图

3. **可能的解决方案**：
   - 切换到备用 API 服务器
   - 使用 OpenAI 官方 API
   - 调整超时时间
   - 修改网络配置

---

**创建时间**: 2025-01-18  
**目的**: 诊断万邦 OpenAI API 调用问题  
**状态**: 待测试


