# 阿里云百炼API部署指南

## 🎉 测试成功确认

✅ **基础流程测试通过**
- 云函数调用正常
- 参数传递正确
- 数据库操作成功
- 前端展示正常

现在可以启用真正的阿里云百炼API调用了！

## 📋 部署步骤

### 1. 获取阿里云百炼API凭证

#### 1.1 登录阿里云控制台
- 访问：https://dashscope.console.aliyun.com/
- 使用阿里云账号登录

#### 1.2 获取API Key
1. 进入"API-KEY管理"页面
2. 创建新的API Key或使用现有的
3. 复制API Key（格式如：`sk-xxxxxxxxxx`）

#### 1.3 创建应用
1. 进入"应用管理"页面
2. 创建新应用或使用现有应用
3. 复制应用ID（App ID）

### 2. 配置云函数环境变量

#### 2.1 在微信开发者工具中配置
1. 打开微信开发者工具
2. 右键点击 `cloudfunctions/aiAnalysis` 文件夹
3. 选择"云函数配置"
4. 在"环境变量"中添加：

```json
{
  "DASHSCOPE_API_KEY": "你的阿里云百炼API密钥",
  "APP_ID": "你的百炼应用ID"
}
```

#### 2.2 示例配置
```json
{
  "DASHSCOPE_API_KEY": "sk-1234567890abcdef",
  "APP_ID": "app-12345678"
}
```

### 3. 重新部署云函数

#### 3.1 部署aiAnalysis云函数
1. 右键点击 `cloudfunctions/aiAnalysis` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

#### 3.2 验证部署
```bash
# 在微信开发者工具终端中查看部署状态
wx cloud functions:list
```

### 4. 测试真实API调用

#### 4.1 在小程序中测试
1. 输入详细的户型描述
2. 填写基本信息（可选）
3. 选择关注方面
4. 点击"开始分析"

#### 4.2 预期结果
- 分析时间：10-30秒
- 返回真实的AI分析结果
- 包含专业的风水建议

## 🔍 调试和监控

### 1. 查看云函数日志
```bash
# 查看最近的调用日志
wx cloud functions:log aiAnalysis --limit 10
```

### 2. 监控API调用
在阿里云控制台中可以查看：
- API调用次数
- 调用成功率
- 响应时间
- 错误统计

### 3. 常见问题排查

#### API Key无效
```
错误: API调用失败: 401 - Unauthorized
解决: 检查API Key是否正确配置
```

#### 应用ID错误
```
错误: API调用失败: 404 - App not found
解决: 检查App ID是否正确
```

#### 调用超时
```
错误: timeout of 30000ms exceeded
解决: 检查网络连接，或增加超时时间
```

#### 配额不足
```
错误: API调用失败: 429 - Rate limit exceeded
解决: 检查API调用配额，升级套餐
```

## 📊 API调用详情

### 请求格式
```json
{
  "input": {
    "prompt": "请作为专业的风水大师，对以下户型进行详细的风水分析：\n\n户型描述：\n进门是玄关，左边是客厅朝南..."
  },
  "parameters": {},
  "debug": {}
}
```

### 响应格式
```json
{
  "output": {
    "text": "{\"overallScore\": 85, \"aspects\": [...], \"summary\": \"...\"}"
  },
  "usage": {
    "input_tokens": 1234,
    "output_tokens": 567
  },
  "request_id": "req-12345678"
}
```

## 💰 成本控制

### 1. Token消费估算
- 输入Token：约500-1000（根据描述长度）
- 输出Token：约300-800（根据分析详细程度）
- 单次分析成本：约0.01-0.05元

### 2. 优化建议
- 合理控制提示词长度
- 设置合适的输出长度限制
- 监控日常调用量
- 设置预算告警

## 🚀 性能优化

### 1. 云函数优化
- 超时时间：30秒（已配置）
- 内存配置：512MB（推荐）
- 并发限制：根据需要调整

### 2. 用户体验优化
- 显示分析进度
- 提供预估时间
- 支持取消操作
- 缓存分析结果

## 📝 使用建议

### 1. 提示词优化
当前提示词已包含：
- 专业角色设定
- 详细的户型信息
- 明确的输出格式要求
- 容错处理说明

### 2. 结果处理
- JSON格式解析
- 默认值处理
- 错误格式兼容
- 用户友好展示

## ✅ 部署完成检查

部署完成后，请确认：
- [ ] 环境变量已正确配置
- [ ] 云函数部署成功
- [ ] API调用正常
- [ ] 分析结果正确显示
- [ ] 错误处理正常
- [ ] 日志记录完整

## 🎯 下一步优化

1. **功能增强**
   - 支持图片上传分析
   - 添加历史记录查看
   - 实现结果分享功能

2. **性能提升**
   - 实现结果缓存
   - 优化提示词效率
   - 支持批量分析

3. **用户体验**
   - 添加分析进度条
   - 支持中断和重试
   - 提供更多自定义选项

现在您的AI户型风水分析功能已经完全就绪，可以为用户提供真正的AI驱动的专业分析服务！

