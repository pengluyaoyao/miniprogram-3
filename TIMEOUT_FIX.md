# äº‘å‡½æ•°è¶…æ—¶é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

è°ƒç”¨ AI åˆ†æäº‘å‡½æ•°æ—¶å‡ºç°è¶…æ—¶é”™è¯¯ï¼š
```
{"errorCode":-1,"errorMessage":"Invoking task timed out after 3 seconds","statusCode":433}
```

## é—®é¢˜åŸå› 

1. **äº‘å‡½æ•°æ‰§è¡Œæ—¶é—´é•¿**ï¼šè°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼ API è¿›è¡Œ AI åˆ†æéœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆé€šå¸¸ 10-60 ç§’ï¼‰
2. **é»˜è®¤è¶…æ—¶è®¾ç½®ä¸è¶³**ï¼šåŸé…ç½®å¯èƒ½æ— æ³•æ»¡è¶³å®é™…éœ€æ±‚

## è§£å†³æ–¹æ¡ˆ

### 1. å¢åŠ äº‘å‡½æ•°è¶…æ—¶é…ç½®

**ä¿®æ”¹æ–‡ä»¶**: `cloudfunctions.json`

```json
{
  "name": "aiAnalysis",
  "timeout": 120,          // ä» 60 ç§’å¢åŠ åˆ° 120 ç§’
  "memorySize": 256,       // å¢åŠ å†…å­˜é…ç½®
  "envVariables": {
    "DASHSCOPE_API_KEY": "",
    "APP_ID": ""
  },
  "runtime": "Nodejs18.15"
}
```

**è¯´æ˜**:
- `timeout`: 120 ç§’ï¼ˆ2 åˆ†é’Ÿï¼‰ï¼Œè¶³å¤Ÿå¤„ç†å¤§å¤šæ•° AI åˆ†æè¯·æ±‚
- `memorySize`: 256 MBï¼Œæä¾›æ›´å¤šå†…å­˜èµ„æº

### 2. å¢åŠ  HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´

**ä¿®æ”¹æ–‡ä»¶**: `cloudfunctions/aiAnalysis/index.js`

```javascript
const response = await axios.post(url, data, {
  headers: {
    'Authorization': `Bearer ${apiKey}`,
    'Content-Type': 'application/json'
  },
  timeout: 90000  // ä» 30 ç§’å¢åŠ åˆ° 90 ç§’
});
```

**è¯´æ˜**: é˜¿é‡Œäº‘ç™¾ç‚¼ API åœ¨å¤„ç†å¤æ‚åˆ†ææ—¶å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œ90 ç§’çš„è¶…æ—¶é…ç½®æ›´åŠ åˆç†ã€‚

### 3. ä¼˜åŒ–å‰ç«¯ç”¨æˆ·ä½“éªŒ

**ä¿®æ”¹æ–‡ä»¶**: `miniprogram/pages/analysis/analysis.ts`

#### 3.1 æ·»åŠ åŠ è½½æç¤º

```typescript
// æ˜¾ç¤ºåŠ è½½æç¤º
wx.showLoading({
  title: 'AIåˆ†æä¸­...',
  mask: true  // é˜»æ­¢ç”¨æˆ·æ“ä½œ
});
```

#### 3.2 ä¼˜åŒ–é”™è¯¯æç¤º

```typescript
// ä½¿ç”¨ Modal æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
wx.showModal({
  title: 'åˆ†æå¤±è´¥',
  content: errorMsg,
  showCancel: false,
  confirmText: 'æˆ‘çŸ¥é“äº†'
});
```

#### 3.3 ç¡®ä¿å…³é—­åŠ è½½çŠ¶æ€

```typescript
// æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½è¦éšè— loading
wx.hideLoading();
```

## è¶…æ—¶æ—¶é—´é…ç½®å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‘å‡½æ•°é…ç½® (cloudfunctions.json)         â”‚
â”‚ timeout: 120 ç§’                          â”‚
â”‚ â†“ æœ€å¤–å±‚ä¿æŠ¤ï¼Œäº‘å‡½æ•°æ‰§è¡Œçš„æœ€å¤§æ—¶é—´        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Axios HTTP è¯·æ±‚ (index.js)               â”‚
â”‚ timeout: 90 ç§’                           â”‚
â”‚ â†“ è°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼ API çš„è¶…æ—¶æ—¶é—´          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¿é‡Œäº‘ç™¾ç‚¼ API                           â”‚
â”‚ å®é™…å¤„ç†æ—¶é—´: 10-60 ç§’                   â”‚
â”‚ â†“ AI æ¨¡å‹æ‰§è¡Œåˆ†æ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®åŸåˆ™

1. **äº‘å‡½æ•°è¶…æ—¶** > **HTTP è¯·æ±‚è¶…æ—¶** > **å®é™…å¤„ç†æ—¶é—´**
2. é¢„ç•™è¶³å¤Ÿçš„ç¼“å†²æ—¶é—´å¤„ç†ç½‘ç»œå»¶è¿Ÿ
3. è€ƒè™‘æç«¯æƒ…å†µä¸‹çš„æœ€é•¿å¤„ç†æ—¶é—´

## éƒ¨ç½²æ­¥éª¤

### 1. æ›´æ–°äº‘å‡½æ•°é…ç½®

```bash
# ä¿®æ”¹å®Œ cloudfunctions.json å
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
å³é”® cloudfunctions/aiAnalysis 
â†’ é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
```

### 2. éªŒè¯é…ç½®

åœ¨äº‘å¼€å‘æ§åˆ¶å°æŸ¥çœ‹äº‘å‡½æ•°é…ç½®ï¼š
- **è¶…æ—¶æ—¶é—´**: 120 ç§’ âœ…
- **å†…å­˜**: 256 MB âœ…
- **ç¯å¢ƒå˜é‡**: DASHSCOPE_API_KEY, APP_ID âœ…

### 3. æµ‹è¯•åŠŸèƒ½

1. åœ¨å°ç¨‹åºåˆ†æé¡µé¢è¾“å…¥æˆ·å‹ä¿¡æ¯
2. ç‚¹å‡»"å¼€å§‹åˆ†æ"
3. è§‚å¯ŸåŠ è½½æç¤º "AIåˆ†æä¸­..."
4. ç­‰å¾…åˆ†æç»“æœï¼ˆå¯èƒ½éœ€è¦ 30-60 ç§’ï¼‰
5. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—ç¡®è®¤æ‰§è¡ŒæˆåŠŸ

## ç›‘æ§å»ºè®®

### 1. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ äº‘å‡½æ•° â†’ aiAnalysis â†’ æ—¥å¿—ï¼š

- è¯·æ±‚å‚æ•°æ˜¯å¦æ­£ç¡®
- API è°ƒç”¨æ˜¯å¦æˆåŠŸ
- å“åº”æ—¶é—´ç»Ÿè®¡
- é”™è¯¯ä¿¡æ¯è¯¦æƒ…

### 2. æ€§èƒ½æŒ‡æ ‡

å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š
- **å¹³å‡æ‰§è¡Œæ—¶é—´**: åº”è¯¥åœ¨ 20-40 ç§’
- **æˆåŠŸç‡**: åº”è¯¥ > 95%
- **è¶…æ—¶æ¬¡æ•°**: åº”è¯¥æ¥è¿‘ 0

### 3. å¼‚å¸¸æƒ…å†µå¤„ç†

å¦‚æœä»ç„¶å‡ºç°è¶…æ—¶ï¼š

**å¯èƒ½åŸå› **:
- é˜¿é‡Œäº‘ç™¾ç‚¼ API æœåŠ¡å¼‚å¸¸
- ç½‘ç»œè¿æ¥ä¸ç¨³å®š
- è¯·æ±‚å‚æ•°è¿‡äºå¤æ‚

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆ
- æŸ¥çœ‹é˜¿é‡Œäº‘æœåŠ¡çŠ¶æ€
- ç®€åŒ–åˆ†æå‚æ•°
- è”ç³»é˜¿é‡Œäº‘æŠ€æœ¯æ”¯æŒ

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### ç­‰å¾…æ—¶é—´è¯´æ˜

åœ¨åˆ†æé¡µé¢æ·»åŠ æç¤ºï¼š
```
"AI åˆ†æéœ€è¦ 30-60 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…"
```

### è¿›åº¦åé¦ˆ

è€ƒè™‘æ·»åŠ è¿›åº¦æ¡æˆ–åŠ¨ç”»æ•ˆæœï¼š
- é˜¶æ®µ 1: æ¥æ”¶å‚æ•° â³
- é˜¶æ®µ 2: AI åˆ†æä¸­ ğŸ¤–
- é˜¶æ®µ 3: ç”ŸæˆæŠ¥å‘Š ğŸ“Š

### å¤±è´¥é‡è¯•

å…è®¸ç”¨æˆ·é‡è¯•å¤±è´¥çš„åˆ†æï¼š
```typescript
wx.showModal({
  title: 'åˆ†æå¤±è´¥',
  content: 'ç½‘ç»œä¸ç¨³å®šï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ',
  confirmText: 'é‡è¯•',
  success: (res) => {
    if (res.confirm) {
      this.startAnalysis();
    }
  }
});
```

## ç›¸å…³æ–‡ä»¶

- `/cloudfunctions.json` - äº‘å‡½æ•°é…ç½®
- `/cloudfunctions/aiAnalysis/index.js` - äº‘å‡½æ•°ä»£ç 
- `/miniprogram/services/aiService.ts` - å‰ç«¯æœåŠ¡
- `/miniprogram/pages/analysis/analysis.ts` - åˆ†æé¡µé¢

## æŠ€æœ¯æ–‡æ¡£

- [å¾®ä¿¡äº‘å¼€å‘ - äº‘å‡½æ•°](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/capabilities.html#äº‘å‡½æ•°)
- [é˜¿é‡Œäº‘ç™¾ç‚¼ API æ–‡æ¡£](https://help.aliyun.com/zh/model-studio/developer-reference/api-reference)
- [Axios é…ç½®æ–‡æ¡£](https://axios-http.com/docs/req_config)

## æ›´æ–°æ—¥å¿—

- **2025-10-03**: ä¿®å¤è¶…æ—¶é—®é¢˜
  - äº‘å‡½æ•°è¶…æ—¶: 60s â†’ 120s
  - HTTP è¶…æ—¶: 30s â†’ 90s
  - å¢åŠ å†…å­˜é…ç½®: 256 MB
  - ä¼˜åŒ–å‰ç«¯åŠ è½½æç¤º

