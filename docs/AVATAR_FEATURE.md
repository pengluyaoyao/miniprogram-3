# 头像编辑功能说明

## 🎯 功能概述

在用户头像旁边添加了编辑资料按钮，用户可以：
- 更换头像（使用用户ID作为文件名）
- 编辑昵称
- 查看资料详情

## 📱 界面变化

### 头像区域
- 头像右下角添加了编辑按钮（白色圆形按钮，蓝色编辑图标）
- 显示用户ID信息
- 点击头像或编辑按钮都可以触发编辑功能

### 编辑选项
用户点击编辑按钮后，会弹出操作菜单：
1. **更换头像** - 选择新头像并上传
2. **编辑昵称** - 修改用户昵称
3. **查看资料** - 查看完整资料信息

## 🔧 技术实现

### 文件命名规则
头像文件使用以下命名格式：
```
avatars/{userId}_{timestamp}.{extension}
```

例如：
```
avatars/user123_1704067200000.jpg
avatars/openid456_1704067200000.png
```

### 云存储结构
```
avatars/
├── user123_1704067200000.jpg
├── user456_1704067300000.png
└── openid789_1704067400000.jpg
```

### 自动清理
- 上传新头像时自动删除旧头像
- 避免云存储空间浪费
- 异步删除，不影响用户体验

## 🚀 使用方法

### 1. 更换头像
1. 点击头像或编辑按钮
2. 选择"更换头像"
3. 从相册选择或拍照
4. 系统自动上传并更新

### 2. 编辑昵称
1. 点击编辑按钮
2. 选择"编辑昵称"
3. 输入新昵称
4. 确认保存

### 3. 查看资料
1. 点击编辑按钮
2. 选择"查看资料"
3. 查看完整用户信息

## 📋 部署要求

### 云函数
需要部署以下云函数：
- `deleteOldAvatar` - 删除旧头像

### 云存储权限
`avatars/` 文件夹需要配置权限：
```json
{
  "read": true,
  "write": "auth.openid != null"
}
```

### 数据库权限
`users` 集合需要配置权限：
```json
{
  "read": "auth.openid == resource._openid",
  "write": "auth.openid == resource._openid"
}
```

## 🔍 调试信息

### 上传流程
1. 选择图片 → 2. 生成文件名 → 3. 上传到云存储 → 4. 更新数据库 → 5. 删除旧头像

### 错误处理
- 上传失败时显示错误提示
- 网络异常时自动重试
- 权限不足时引导用户重新登录

## 📊 性能优化

### 图片压缩
- 自动压缩上传的图片
- 支持多种图片格式
- 优化存储空间

### 缓存策略
- 本地缓存用户信息
- 减少数据库查询
- 提升用户体验

## 🎨 样式说明

### 编辑按钮样式
```css
.edit-avatar-btn {
  position: absolute;
  bottom: 8rpx;
  right: 8rpx;
  width: 48rpx;
  height: 48rpx;
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  box-shadow: 0 4rpx 8rpx rgba(0, 0, 0, 0.2);
}
```

### 响应式设计
- 适配不同屏幕尺寸
- 支持深色模式
- 符合微信设计规范

## 🚨 注意事项

1. **权限检查**: 确保用户已登录才能编辑资料
2. **文件大小**: 建议限制头像文件大小（如2MB以内）
3. **格式支持**: 支持常见图片格式（jpg, png, gif）
4. **错误处理**: 完善的错误提示和异常处理
5. **数据同步**: 确保本地和云端数据同步

## 🔄 后续优化

1. **头像裁剪**: 添加头像裁剪功能
2. **批量操作**: 支持批量更换头像
3. **历史记录**: 保存头像更换历史
4. **个性化**: 更多个性化设置选项
